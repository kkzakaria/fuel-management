revoke delete on table "public"."chauffeur" from "anon";

revoke insert on table "public"."chauffeur" from "anon";

revoke references on table "public"."chauffeur" from "anon";

revoke select on table "public"."chauffeur" from "anon";

revoke trigger on table "public"."chauffeur" from "anon";

revoke truncate on table "public"."chauffeur" from "anon";

revoke update on table "public"."chauffeur" from "anon";

revoke delete on table "public"."chauffeur" from "authenticated";

revoke insert on table "public"."chauffeur" from "authenticated";

revoke references on table "public"."chauffeur" from "authenticated";

revoke select on table "public"."chauffeur" from "authenticated";

revoke trigger on table "public"."chauffeur" from "authenticated";

revoke truncate on table "public"."chauffeur" from "authenticated";

revoke update on table "public"."chauffeur" from "authenticated";

revoke delete on table "public"."chauffeur" from "service_role";

revoke insert on table "public"."chauffeur" from "service_role";

revoke references on table "public"."chauffeur" from "service_role";

revoke select on table "public"."chauffeur" from "service_role";

revoke trigger on table "public"."chauffeur" from "service_role";

revoke truncate on table "public"."chauffeur" from "service_role";

revoke update on table "public"."chauffeur" from "service_role";

revoke delete on table "public"."conteneur_trajet" from "anon";

revoke insert on table "public"."conteneur_trajet" from "anon";

revoke references on table "public"."conteneur_trajet" from "anon";

revoke select on table "public"."conteneur_trajet" from "anon";

revoke trigger on table "public"."conteneur_trajet" from "anon";

revoke truncate on table "public"."conteneur_trajet" from "anon";

revoke update on table "public"."conteneur_trajet" from "anon";

revoke delete on table "public"."conteneur_trajet" from "authenticated";

revoke insert on table "public"."conteneur_trajet" from "authenticated";

revoke references on table "public"."conteneur_trajet" from "authenticated";

revoke select on table "public"."conteneur_trajet" from "authenticated";

revoke trigger on table "public"."conteneur_trajet" from "authenticated";

revoke truncate on table "public"."conteneur_trajet" from "authenticated";

revoke update on table "public"."conteneur_trajet" from "authenticated";

revoke delete on table "public"."conteneur_trajet" from "service_role";

revoke insert on table "public"."conteneur_trajet" from "service_role";

revoke references on table "public"."conteneur_trajet" from "service_role";

revoke select on table "public"."conteneur_trajet" from "service_role";

revoke trigger on table "public"."conteneur_trajet" from "service_role";

revoke truncate on table "public"."conteneur_trajet" from "service_role";

revoke update on table "public"."conteneur_trajet" from "service_role";

revoke delete on table "public"."localite" from "anon";

revoke insert on table "public"."localite" from "anon";

revoke references on table "public"."localite" from "anon";

revoke select on table "public"."localite" from "anon";

revoke trigger on table "public"."localite" from "anon";

revoke truncate on table "public"."localite" from "anon";

revoke update on table "public"."localite" from "anon";

revoke delete on table "public"."localite" from "authenticated";

revoke insert on table "public"."localite" from "authenticated";

revoke references on table "public"."localite" from "authenticated";

revoke select on table "public"."localite" from "authenticated";

revoke trigger on table "public"."localite" from "authenticated";

revoke truncate on table "public"."localite" from "authenticated";

revoke update on table "public"."localite" from "authenticated";

revoke delete on table "public"."localite" from "service_role";

revoke insert on table "public"."localite" from "service_role";

revoke references on table "public"."localite" from "service_role";

revoke select on table "public"."localite" from "service_role";

revoke trigger on table "public"."localite" from "service_role";

revoke truncate on table "public"."localite" from "service_role";

revoke update on table "public"."localite" from "service_role";

revoke delete on table "public"."mission_sous_traitance" from "anon";

revoke insert on table "public"."mission_sous_traitance" from "anon";

revoke references on table "public"."mission_sous_traitance" from "anon";

revoke select on table "public"."mission_sous_traitance" from "anon";

revoke trigger on table "public"."mission_sous_traitance" from "anon";

revoke truncate on table "public"."mission_sous_traitance" from "anon";

revoke update on table "public"."mission_sous_traitance" from "anon";

revoke delete on table "public"."mission_sous_traitance" from "authenticated";

revoke insert on table "public"."mission_sous_traitance" from "authenticated";

revoke references on table "public"."mission_sous_traitance" from "authenticated";

revoke select on table "public"."mission_sous_traitance" from "authenticated";

revoke trigger on table "public"."mission_sous_traitance" from "authenticated";

revoke truncate on table "public"."mission_sous_traitance" from "authenticated";

revoke update on table "public"."mission_sous_traitance" from "authenticated";

revoke delete on table "public"."mission_sous_traitance" from "service_role";

revoke insert on table "public"."mission_sous_traitance" from "service_role";

revoke references on table "public"."mission_sous_traitance" from "service_role";

revoke select on table "public"."mission_sous_traitance" from "service_role";

revoke trigger on table "public"."mission_sous_traitance" from "service_role";

revoke truncate on table "public"."mission_sous_traitance" from "service_role";

revoke update on table "public"."mission_sous_traitance" from "service_role";

revoke delete on table "public"."profiles" from "anon";

revoke insert on table "public"."profiles" from "anon";

revoke references on table "public"."profiles" from "anon";

revoke select on table "public"."profiles" from "anon";

revoke trigger on table "public"."profiles" from "anon";

revoke truncate on table "public"."profiles" from "anon";

revoke update on table "public"."profiles" from "anon";

revoke delete on table "public"."profiles" from "authenticated";

revoke insert on table "public"."profiles" from "authenticated";

revoke references on table "public"."profiles" from "authenticated";

revoke select on table "public"."profiles" from "authenticated";

revoke trigger on table "public"."profiles" from "authenticated";

revoke truncate on table "public"."profiles" from "authenticated";

revoke update on table "public"."profiles" from "authenticated";

revoke delete on table "public"."profiles" from "service_role";

revoke insert on table "public"."profiles" from "service_role";

revoke references on table "public"."profiles" from "service_role";

revoke select on table "public"."profiles" from "service_role";

revoke trigger on table "public"."profiles" from "service_role";

revoke truncate on table "public"."profiles" from "service_role";

revoke update on table "public"."profiles" from "service_role";

revoke delete on table "public"."sous_traitant" from "anon";

revoke insert on table "public"."sous_traitant" from "anon";

revoke references on table "public"."sous_traitant" from "anon";

revoke select on table "public"."sous_traitant" from "anon";

revoke trigger on table "public"."sous_traitant" from "anon";

revoke truncate on table "public"."sous_traitant" from "anon";

revoke update on table "public"."sous_traitant" from "anon";

revoke delete on table "public"."sous_traitant" from "authenticated";

revoke insert on table "public"."sous_traitant" from "authenticated";

revoke references on table "public"."sous_traitant" from "authenticated";

revoke select on table "public"."sous_traitant" from "authenticated";

revoke trigger on table "public"."sous_traitant" from "authenticated";

revoke truncate on table "public"."sous_traitant" from "authenticated";

revoke update on table "public"."sous_traitant" from "authenticated";

revoke delete on table "public"."sous_traitant" from "service_role";

revoke insert on table "public"."sous_traitant" from "service_role";

revoke references on table "public"."sous_traitant" from "service_role";

revoke select on table "public"."sous_traitant" from "service_role";

revoke trigger on table "public"."sous_traitant" from "service_role";

revoke truncate on table "public"."sous_traitant" from "service_role";

revoke update on table "public"."sous_traitant" from "service_role";

revoke delete on table "public"."trajet" from "anon";

revoke insert on table "public"."trajet" from "anon";

revoke references on table "public"."trajet" from "anon";

revoke select on table "public"."trajet" from "anon";

revoke trigger on table "public"."trajet" from "anon";

revoke truncate on table "public"."trajet" from "anon";

revoke update on table "public"."trajet" from "anon";

revoke delete on table "public"."trajet" from "authenticated";

revoke insert on table "public"."trajet" from "authenticated";

revoke references on table "public"."trajet" from "authenticated";

revoke select on table "public"."trajet" from "authenticated";

revoke trigger on table "public"."trajet" from "authenticated";

revoke truncate on table "public"."trajet" from "authenticated";

revoke update on table "public"."trajet" from "authenticated";

revoke delete on table "public"."trajet" from "service_role";

revoke insert on table "public"."trajet" from "service_role";

revoke references on table "public"."trajet" from "service_role";

revoke select on table "public"."trajet" from "service_role";

revoke trigger on table "public"."trajet" from "service_role";

revoke truncate on table "public"."trajet" from "service_role";

revoke update on table "public"."trajet" from "service_role";

revoke delete on table "public"."type_conteneur" from "anon";

revoke insert on table "public"."type_conteneur" from "anon";

revoke references on table "public"."type_conteneur" from "anon";

revoke select on table "public"."type_conteneur" from "anon";

revoke trigger on table "public"."type_conteneur" from "anon";

revoke truncate on table "public"."type_conteneur" from "anon";

revoke update on table "public"."type_conteneur" from "anon";

revoke delete on table "public"."type_conteneur" from "authenticated";

revoke insert on table "public"."type_conteneur" from "authenticated";

revoke references on table "public"."type_conteneur" from "authenticated";

revoke select on table "public"."type_conteneur" from "authenticated";

revoke trigger on table "public"."type_conteneur" from "authenticated";

revoke truncate on table "public"."type_conteneur" from "authenticated";

revoke update on table "public"."type_conteneur" from "authenticated";

revoke delete on table "public"."type_conteneur" from "service_role";

revoke insert on table "public"."type_conteneur" from "service_role";

revoke references on table "public"."type_conteneur" from "service_role";

revoke select on table "public"."type_conteneur" from "service_role";

revoke trigger on table "public"."type_conteneur" from "service_role";

revoke truncate on table "public"."type_conteneur" from "service_role";

revoke update on table "public"."type_conteneur" from "service_role";

revoke delete on table "public"."vehicule" from "anon";

revoke insert on table "public"."vehicule" from "anon";

revoke references on table "public"."vehicule" from "anon";

revoke select on table "public"."vehicule" from "anon";

revoke trigger on table "public"."vehicule" from "anon";

revoke truncate on table "public"."vehicule" from "anon";

revoke update on table "public"."vehicule" from "anon";

revoke delete on table "public"."vehicule" from "authenticated";

revoke insert on table "public"."vehicule" from "authenticated";

revoke references on table "public"."vehicule" from "authenticated";

revoke select on table "public"."vehicule" from "authenticated";

revoke trigger on table "public"."vehicule" from "authenticated";

revoke truncate on table "public"."vehicule" from "authenticated";

revoke update on table "public"."vehicule" from "authenticated";

revoke delete on table "public"."vehicule" from "service_role";

revoke insert on table "public"."vehicule" from "service_role";

revoke references on table "public"."vehicule" from "service_role";

revoke select on table "public"."vehicule" from "service_role";

revoke trigger on table "public"."vehicule" from "service_role";

revoke truncate on table "public"."vehicule" from "service_role";

revoke update on table "public"."vehicule" from "service_role";

set check_function_bodies = off;

CREATE OR REPLACE FUNCTION public.create_test_profiles()
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  admin_uuid UUID;
  gestionnaire_uuid UUID;
  chauffeur1_uuid UUID;
  chauffeur2_uuid UUID;
  personnel_uuid UUID;
  test_chauffeur1_id UUID;
  test_chauffeur2_id UUID;
BEGIN
  -- Get UUIDs from auth.users (these users must exist first)
  SELECT id INTO admin_uuid FROM auth.users WHERE email = 'admin@transport.ci';
  SELECT id INTO gestionnaire_uuid FROM auth.users WHERE email = 'gestionnaire@transport.ci';
  SELECT id INTO chauffeur1_uuid FROM auth.users WHERE email = 'chauffeur1@transport.ci';
  SELECT id INTO chauffeur2_uuid FROM auth.users WHERE email = 'chauffeur2@transport.ci';
  SELECT id INTO personnel_uuid FROM auth.users WHERE email = 'personnel@transport.ci';

  -- Get test chauffeur IDs
  SELECT id INTO test_chauffeur1_id FROM public.CHAUFFEUR WHERE nom = 'Kouassi' AND prenom = 'Jean-Baptiste';
  SELECT id INTO test_chauffeur2_id FROM public.CHAUFFEUR WHERE nom = 'Coulibaly' AND prenom = 'Mamadou';

  -- Only proceed if admin user exists (all others are optional)
  IF admin_uuid IS NOT NULL THEN
    -- Insert or update admin profile
    INSERT INTO public.profiles (id, email, role, nom, prenom, telephone, is_active)
    VALUES (admin_uuid, 'admin@transport.ci', 'admin', 'Admin', 'Système', '+225 27 20 00 00 01', true)
    ON CONFLICT (id) DO UPDATE SET
      role = 'admin',
      nom = 'Admin',
      prenom = 'Système',
      is_active = true;

    RAISE NOTICE 'Admin profile created/updated';
  END IF;

  IF gestionnaire_uuid IS NOT NULL THEN
    -- Insert or update gestionnaire profile
    INSERT INTO public.profiles (id, email, role, nom, prenom, telephone, is_active)
    VALUES (gestionnaire_uuid, 'gestionnaire@transport.ci', 'gestionnaire', 'Diaby', 'Aminata', '+225 27 20 00 00 02', true)
    ON CONFLICT (id) DO UPDATE SET
      role = 'gestionnaire',
      nom = 'Diaby',
      prenom = 'Aminata',
      is_active = true;

    RAISE NOTICE 'Gestionnaire profile created/updated';
  END IF;

  IF chauffeur1_uuid IS NOT NULL AND test_chauffeur1_id IS NOT NULL THEN
    -- Insert or update chauffeur1 profile (linked to CHAUFFEUR table)
    INSERT INTO public.profiles (id, email, role, nom, prenom, telephone, chauffeur_id, is_active)
    VALUES (chauffeur1_uuid, 'chauffeur1@transport.ci', 'chauffeur', 'Kouassi', 'Jean-Baptiste', '+225 07 12 34 56 78', test_chauffeur1_id, true)
    ON CONFLICT (id) DO UPDATE SET
      role = 'chauffeur',
      chauffeur_id = test_chauffeur1_id,
      is_active = true;

    RAISE NOTICE 'Chauffeur1 profile created/updated and linked to CHAUFFEUR table';
  END IF;

  IF chauffeur2_uuid IS NOT NULL AND test_chauffeur2_id IS NOT NULL THEN
    -- Insert or update chauffeur2 profile (linked to CHAUFFEUR table)
    INSERT INTO public.profiles (id, email, role, nom, prenom, telephone, chauffeur_id, is_active)
    VALUES (chauffeur2_uuid, 'chauffeur2@transport.ci', 'chauffeur', 'Coulibaly', 'Mamadou', '+225 05 23 45 67 89', test_chauffeur2_id, true)
    ON CONFLICT (id) DO UPDATE SET
      role = 'chauffeur',
      chauffeur_id = test_chauffeur2_id,
      is_active = true;

    RAISE NOTICE 'Chauffeur2 profile created/updated and linked to CHAUFFEUR table';
  END IF;

  IF personnel_uuid IS NOT NULL THEN
    -- Insert or update personnel profile
    INSERT INTO public.profiles (id, email, role, nom, prenom, telephone, is_active)
    VALUES (personnel_uuid, 'personnel@transport.ci', 'personnel', 'N''Guessan', 'Christelle', '+225 27 20 00 00 03', true)
    ON CONFLICT (id) DO UPDATE SET
      role = 'personnel',
      nom = 'N''Guessan',
      prenom = 'Christelle',
      is_active = true;

    RAISE NOTICE 'Personnel profile created/updated';
  END IF;

END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_current_chauffeur_id()
 RETURNS uuid
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  chauffeur_uuid UUID;
BEGIN
  SELECT chauffeur_id INTO chauffeur_uuid
  FROM public.profiles
  WHERE id = auth.uid() AND role = 'chauffeur' AND is_active = TRUE;

  RETURN chauffeur_uuid;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.handle_new_user()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  INSERT INTO public.profiles (id, email, role)
  VALUES (NEW.id, NEW.email, 'personnel');
  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.is_admin()
 RETURNS boolean
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  RETURN EXISTS (
    SELECT 1 FROM public.profiles
    WHERE id = auth.uid() AND role = 'admin' AND is_active = TRUE
  );
END;
$function$
;

CREATE OR REPLACE FUNCTION public.is_chauffeur()
 RETURNS boolean
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  RETURN EXISTS (
    SELECT 1 FROM public.profiles
    WHERE id = auth.uid() AND role = 'chauffeur' AND is_active = TRUE
  );
END;
$function$
;

CREATE OR REPLACE FUNCTION public.is_gestionnaire_or_admin()
 RETURNS boolean
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  RETURN EXISTS (
    SELECT 1 FROM public.profiles
    WHERE id = auth.uid()
      AND role IN ('admin', 'gestionnaire')
      AND is_active = TRUE
  );
END;
$function$
;

CREATE OR REPLACE FUNCTION public.update_last_login()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  UPDATE public.profiles
  SET last_login = NOW()
  WHERE id = NEW.id;
  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.update_updated_at_column()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$function$
;



